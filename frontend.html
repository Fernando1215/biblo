<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca Personal - Leer contenidos</title>
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f5f1e9; margin:0; padding:0; display:flex; justify-content:center; min-height:100vh; padding-top:30px }
    .container { background:#fffdfa; max-width:900px; width:95%; padding:20px 28px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08) }
    h1,h2,h3{ color:#2f4a1f }
    input, textarea, button, select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:2px solid #9caf88; font-size:15px; box-sizing:border-box }
    textarea { min-height:120px; resize:vertical }
    button { background:#4caf50; color:#fff; border:none; cursor:pointer; font-weight:700 }
    button:hover{ background:#388e3c }
    .libro-item{ padding:12px; margin:8px 0; background:#e7ebd1; border:2px solid #b6c78a; border-radius:8px; display:flex; justify-content:space-between; align-items:center }
    .btn-small{ width:auto; padding:6px 10px; margin-left:6px; font-size:13px }
    #panelUsuario, #detalleLibro, #registro { display:none }
    #cerrarSesion { background:#a44c4c; max-width:150px; margin:14px auto; display:none }
    .content-area{ white-space:pre-wrap; background:#fff; padding:12px; border-radius:8px; border:1px solid #e0e0e0; max-height:300px; overflow:auto }
    .row { display:flex; gap:12px }
    .col { flex:1 }
    .hidden { display:none }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Biblioteca Personal</h1>

    <div id="login">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginClave" placeholder="Contrase√±a" />
      <button onclick="login()">Ingresar</button>
      <button onclick="mostrarRegistro()">Registrar Usuario</button>
    </div>

    <div id="registro">
      <h2>Registrar Usuario</h2>
      <input type="text" id="regNombre" placeholder="Nombre" />
      <input type="email" id="regEmail" placeholder="Email" />
      <input type="password" id="regClave" placeholder="Contrase√±a (m√≠n. 6 caracteres)" />
      <button onclick="registrarUsuario()">Registrar</button>
      <button onclick="volverLogin()">Volver</button>
    </div>

    <div id="panelUsuario">
      <div class="row">
        <div class="col">
          <h2>Cat√°logo Global</h2>
          <div id="catalogoGlobal"></div>
        </div>
        <div class="col">
          <h2>Mi Biblioteca</h2>
          <div id="miBiblioteca"></div>

          <h2>Buscar</h2>
          <input id="qSearch" placeholder="Buscar por t√≠tulo o autor" oninput="buscar()" />
        </div>
      </div>

      <h2 id="hAgregar">Agregar Nuevo Libro</h2>
      <input type="text" id="nuevoTitulo" placeholder="T√≠tulo" />
      <input type="text" id="nuevoAutor" placeholder="Autor" />
      <input type="text" id="nuevaCategoria" placeholder="Categor√≠a" />
      <textarea id="nuevoContenido" placeholder="Contenido del libro (simulado). Puedes escribir varios p√°rrafos."></textarea>
      <button onclick="agregarLibro()" id="btnAgregar">Agregar Libro</button>
    </div>

    <div id="detalleLibro">
      <h3 id="tituloDetalle"></h3>
      <p id="autorDetalle"></p>
      <p id="categoriaDetalle"></p>

      <h4>Contenido</h4>
      <div id="contenidoTexto" class="content-area">(Cargando...)</div>

      <div id="edicionAdmin" class="hidden">
        <h4>Editar contenido (Admin)</h4>
        <textarea id="contenidoEditar" placeholder="Edita el contenido aqu√≠"></textarea>
        <button onclick="guardarContenido()">Guardar contenido</button>
      </div>

      <h4>Rese√±as:</h4>
      <ul id="listaRese√±as"></ul>

      <textarea id="rese√±aTexto" placeholder="Escribe tu rese√±a..."></textarea>
      <input type="number" id="calificacion" min="1" max="5" placeholder="Calificaci√≥n (1-5)" />
      <button onclick="guardarRese√±a()">Guardar Rese√±a</button>

      <button onclick="cerrarDetalle()">Cerrar</button>
    </div>

    <button id="cerrarSesion" onclick="logout()">Cerrar Sesi√≥n</button>
  </div>

  <script>
    let token = null;
    let userRole = null;
    let libroSeleccionado = null;

    const API = '/api/v1';

    async function request(url, options = {}) {
      options.headers = options.headers || {};
      if (token) options.headers['Authorization'] = `Bearer ${token}`;
      if (!options.headers['Content-Type'] && !(options.body instanceof FormData)) options.headers['Content-Type'] = 'application/json';

      const res = await fetch(url, options);
      if (!res.ok) {
        const error = await res.json().catch(() => ({detail: 'Error desconocido'}));
        throw new Error(error.detail || 'Error en la petici√≥n');
      }
      return res.status === 204 ? null : res.json();
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const clave = document.getElementById('loginClave').value;
      try {
        const data = await request(`${API}/auth/login`, { method: 'POST', body: JSON.stringify({ email, clave }) });
        token = data.token;
        userRole = data.rol;

        document.getElementById('login').style.display = 'none';
        document.getElementById('panelUsuario').style.display = 'block';
        document.getElementById('cerrarSesion').style.display = 'block';

        // Ajustes seg√∫n rol
        if (userRole === 'admin') {
          alert('‚úÖ Bienvenido Administrador');
          document.getElementById('hAgregar').style.display = 'block';
          document.getElementById('btnAgregar').style.display = 'block';
        } else {
          alert('‚úÖ Bienvenido Usuario');
          document.getElementById('hAgregar').style.display = 'none';
          document.getElementById('btnAgregar').style.display = 'none';
          document.getElementById('nuevoTitulo').style.display = 'none';
          document.getElementById('nuevoAutor').style.display = 'none';
          document.getElementById('nuevaCategoria').style.display = 'none';
          document.getElementById('nuevoContenido').style.display = 'none';
        }

        await cargarCatalogo();
        await cargarMiBiblioteca();
      } catch (err) {
        alert('Error al iniciar sesi√≥n: ' + err.message);
      }
    }

    function mostrarRegistro() { document.getElementById('login').style.display = 'none'; document.getElementById('registro').style.display = 'block'; }
    function volverLogin() { document.getElementById('registro').style.display = 'none'; document.getElementById('login').style.display = 'block'; }

    async function registrarUsuario() {
      const nombre = document.getElementById('regNombre').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const clave = document.getElementById('regClave').value;
      try {
        await request(`${API}/usuarios`, { method: 'POST', body: JSON.stringify({ nombre, email, clave, rol: 'usuario' }) });
        alert('Usuario registrado con √©xito'); volverLogin();
      } catch (err) { alert('Error al registrar: ' + err.message); }
    }

    function logout() {
      token = null; userRole = null; libroSeleccionado = null;
      document.getElementById('login').style.display = 'block';
      document.getElementById('panelUsuario').style.display = 'none';
      document.getElementById('cerrarSesion').style.display = 'none';
      // mostrar campos agregar
      document.getElementById('hAgregar').style.display = 'block';
      document.getElementById('btnAgregar').style.display = 'block';
      document.getElementById('nuevoTitulo').style.display = 'block';
      document.getElementById('nuevoAutor').style.display = 'block';
      document.getElementById('nuevaCategoria').style.display = 'block';
      document.getElementById('nuevoContenido').style.display = 'block';
    }

    async function cargarCatalogo(q) {
      try {
        const url = `${API}/libros${q ? '?search=' + encodeURIComponent(q) : ''}`;
        const libros = await request(url);
        const cont = document.getElementById('catalogoGlobal'); cont.innerHTML = '';
        libros.forEach(libro => {
          const div = document.createElement('div'); div.className = 'libro-item';
          let botonesHTML = `
            <button class="btn-small" onclick="agregarAMiBiblioteca(${libro.id})">Agregar</button>
            <button class="btn-small" onclick="verDetalle(${libro.id})">Leer</button>
          `;
          if (userRole === 'admin') {
            botonesHTML += ` <button class="btn-small" onclick="editarLibro(${libro.id})" style="background-color:#ff9800">Editar</button> <button class="btn-small" onclick="eliminarLibro(${libro.id})" style="background-color:#f44336">Eliminar</button> `;
          }
          div.innerHTML = `<div><strong>${libro.titulo}</strong> - ${libro.autor} (${libro.categoria})</div><div>${botonesHTML}</div>`;
          cont.appendChild(div);
        });
      } catch (err) { alert('Error al cargar cat√°logo: ' + err.message); }
    }

    function buscar() { const q = document.getElementById('qSearch').value.trim(); cargarCatalogo(q); }

    async function cargarMiBiblioteca() {
      try {
        const libros = await request(`${API}/usuarios/me/biblioteca`);
        const cont = document.getElementById('miBiblioteca'); cont.innerHTML = '';
        if (libros.length === 0) { cont.innerHTML = '<p style="text-align:center;color:#999;padding:20px">üìö Tu biblioteca est√° vac√≠a.</p>'; return; }
        libros.forEach(libro => {
          const div = document.createElement('div'); div.className = 'libro-item';
          div.innerHTML = `<div><strong>${libro.titulo}</strong> - ${libro.autor} (${libro.categoria})</div><div><button class="btn-small" onclick="verDetalle(${libro.id})">Leer</button><button class="btn-small" onclick="quitarDeMiBiblioteca(${libro.id})" style="background-color:#f44336">Quitar</button></div>`;
          cont.appendChild(div);
        });
      } catch (err) { document.getElementById('miBiblioteca').innerHTML = '<p style="color:#f44336">Error: '+err.message+'</p>'; }
    }

    async function agregarLibro() {
      const titulo = document.getElementById('nuevoTitulo').value.trim();
      const autor = document.getElementById('nuevoAutor').value.trim();
      const categoria = document.getElementById('nuevaCategoria').value.trim();
      const contenido = document.getElementById('nuevoContenido').value.trim();
      if (!titulo || !autor || !categoria) { alert('Completa todos los campos'); return; }
      try {
        await request(`${API}/libros`, { method: 'POST', body: JSON.stringify({ titulo, autor, categoria, contenido }) });
        document.getElementById('nuevoTitulo').value=''; document.getElementById('nuevoAutor').value=''; document.getElementById('nuevaCategoria').value=''; document.getElementById('nuevoContenido').value='';
        await cargarCatalogo();
      } catch (err) {
        if (err.message.includes('Solo administradores')) alert('‚ùå Solo administradores pueden crear libros'); else alert('Error al agregar libro: '+err.message);
      }
    }

    async function agregarAMiBiblioteca(libroId) {
      try { await request(`${API}/usuarios/me/biblioteca/${libroId}`, { method: 'POST' }); alert('Libro agregado a tu biblioteca'); await cargarMiBiblioteca(); } catch (err) { alert('Error: '+err.message); }
    }

    async function quitarDeMiBiblioteca(libroId) {
      if (!confirm('¬øSeguro que deseas quitar este libro de tu biblioteca?')) return;
      try { await request(`${API}/usuarios/me/biblioteca/${libroId}`, { method: 'DELETE' }); await cargarMiBiblioteca(); } catch (err) { alert('Error al eliminar libro: '+err.message); }
    }

    async function verDetalle(libroId) {
      try {
        const libro = await request(`${API}/libros/${libroId}`);
        // Intentamos obtener contenido (si el backend expone /libros/{id}/contenido)
        let contenido = '(Sin contenido)';
        try { const c = await request(`${API}/libros/${libroId}/contenido`); contenido = c.contenido || '(Sin contenido)'; } catch(e) { /* backend puede devolver 404 si no existe endpoint */ }

        const rese√±as = await request(`${API}/libros/${libroId}/rese√±as`);
        libroSeleccionado = libro;
        document.getElementById('tituloDetalle').textContent = libro.titulo;
        document.getElementById('autorDetalle').textContent = 'Autor: ' + libro.autor;
        document.getElementById('categoriaDetalle').textContent = 'Categor√≠a: ' + libro.categoria;
        document.getElementById('contenidoTexto').textContent = contenido;

        // Mostrar √°rea de edici√≥n solo a admin
        if (userRole === 'admin') {
          document.getElementById('edicionAdmin').classList.remove('hidden');
          document.getElementById('contenidoEditar').value = contenido === '(Sin contenido)' ? '' : contenido;
        } else {
          document.getElementById('edicionAdmin').classList.add('hidden');
        }

        const lista = document.getElementById('listaRese√±as'); lista.innerHTML = '';
        rese√±as.forEach(r => { const li = document.createElement('li'); li.textContent = `Usuario ${r.usuario_id}: "${r.texto}" (‚≠ê${r.cal})`; lista.appendChild(li); });
        document.getElementById('detalleLibro').style.display = 'block';
      } catch (err) { alert('Error al cargar detalle: '+err.message); }
    }

    async function guardarRese√±a() {
      const texto = document.getElementById('rese√±aTexto').value.trim();
      const cal = parseInt(document.getElementById('calificacion').value);
      if (!texto || !cal || cal<1 || cal>5) { alert('Completa todos los campos correctamente'); return; }
      try { await request(`${API}/libros/${libroSeleccionado.id}/rese√±as`, { method: 'POST', body: JSON.stringify({ texto, cal }) }); document.getElementById('rese√±aTexto').value=''; document.getElementById('calificacion').value=''; alert('Rese√±a guardada ‚úÖ'); await verDetalle(libroSeleccionado.id); } catch (err) { alert('Error al guardar rese√±a: '+err.message); }
    }

    function cerrarDetalle(){ document.getElementById('detalleLibro').style.display='none'; }

    async function editarLibro(libroId) {
      try {
        const libro = await request(`${API}/libros/${libroId}`);
        const nuevoTitulo = prompt('Nuevo t√≠tulo:', libro.titulo); if (!nuevoTitulo) return;
        const nuevoAutor = prompt('Nuevo autor:', libro.autor); if (!nuevoAutor) return;
        const nuevaCategoria = prompt('Nueva categor√≠a:', libro.categoria); if (!nuevaCategoria) return;
        await request(`${API}/libros/${libroId}`, { method: 'PUT', body: JSON.stringify({ titulo: nuevoTitulo, autor: nuevoAutor, categoria: nuevaCategoria }) });
        alert('‚úÖ Libro actualizado'); await cargarCatalogo();
      } catch (err) { alert('Error al editar libro: '+err.message); }
    }

    async function guardarContenido() {
      if (!userRole || userRole !== 'admin') { alert('Solo administradores pueden editar contenido'); return; }
      const nuevo = document.getElementById('contenidoEditar').value;
      try {
        // Intentamos PUT a /libros/{id}/contenido (si el backend lo implementa)
        await request(`${API}/libros/${libroSeleccionado.id}/contenido`, { method: 'PUT', body: JSON.stringify({ contenido: nuevo }) });
        alert('Contenido actualizado ‚úÖ');
        document.getElementById('contenidoTexto').textContent = nuevo;
      } catch (err) { alert('Error al guardar contenido: '+err.message); }
    }

    async function eliminarLibro(libroId) {
      if (!confirm('¬øEst√°s seguro de eliminar este libro?')) return;
      try { await request(`${API}/libros/${libroId}`, { method: 'DELETE' }); alert('‚úÖ Libro eliminado'); await cargarCatalogo(); } catch (err) { alert('Error al eliminar libro: '+err.message); }
    }

    // Auto-load: show login section initially
    document.getElementById('login').style.display = 'block';
  </script>
</body>
</html>